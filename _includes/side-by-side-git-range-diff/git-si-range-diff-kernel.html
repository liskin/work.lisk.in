<!--
# resize terminal to 169 columns
$ pipx install ansi2html
$ DELTA_PAGER=cat ttyrec -e 'git si-range-diff lorenzo-v2...lorenzo-v3' /tmp/rangediff4
$ ttyrec2ansi </tmp/rangediff4 | ansi2html >/tmp/rangediff4.html
-->
<pre class="ansi2html-content body_foreground body_background xx-smaller"><code><!--
--><span class="ansi38-39"></span><span class="ansi38-39 ansi48-235">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
<span class="ansi1 ansi31">1:  81f8e8008c9a </span><span class="ansi1 ansi37">!</span><span class="ansi1 ansi36"> 1:  05fce90455a2</span><span class="ansi1 ansi37"> mm: abstract the vma_merge()/split_vma() pattern for mprotect() et al.</span>

<span class="ansi38-245 ansi48-235">────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> Commit message </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">    parameters, create inline wrapper functions for each of the modify</span>              <span class="ansi38-245"> │ </span><span class="ansi38-231">    parameters, create inline wrapper functions for each of the modify</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">    operations, parameterised only by what is required to perform the action.</span>       <span class="ansi38-245"> │ </span><span class="ansi38-231">    operations, parameterised only by what is required to perform the action.</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">    We can also significantly simplify the logic - by returning the VMA if we</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">    split (or merged VMA if we do not) we no longer need specific handling for</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">    merge/split cases in any of the call sites.</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">    Note that the userfaultfd_release() case works even though it does not</span>          <span class="ansi38-245"> │ </span><span class="ansi38-231">    Note that the userfaultfd_release() case works even though it does not</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">    split VMAs - since start is set to vma-&gt;vm_start and end is set to</span>              <span class="ansi38-245"> │ </span><span class="ansi38-231">    split VMAs - since start is set to vma-&gt;vm_start and end is set to</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">    vma-&gt;vm_end, the split logic does not trigger.</span>                                  <span class="ansi38-245"> │ </span><span class="ansi38-231">    vma-&gt;vm_end, the split logic does not trigger.</span>

<span class="ansi38-245 ansi48-235">────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> Commit message </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">    - vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT, and start - vma-&gt;vm_start will be 0 in this</span>     <span class="ansi38-245"> │ </span><span class="ansi38-231">    - vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT, and start - vma-&gt;vm_start will be 0 in this</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">    instance, this invocation will remain unchanged.</span>                                <span class="ansi38-245"> │ </span><span class="ansi38-231">    instance, this invocation will remain unchanged.</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52">    Signed-off-by: Lorenzo Stoakes &lt;lstoakes@gmail.com&gt;</span><span class="ansi48-52">                             </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">    We eliminate a VM_WARN_ON() in mprotect_fixup() as this simply asserts that</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">    vma_merge() correctly ensures that flags remain the same, something that is</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">    already checked in is_mergeable_vma() and elsewhere, and in any case is not</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">    specific to mprotect().</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">    Reviewed-by: Vlastimil Babka &lt;vbabka@suse.cz&gt;</span>                                   <span class="ansi38-245"> │ </span><span class="ansi38-231">    Reviewed-by: Vlastimil Babka &lt;vbabka@suse.cz&gt;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">    Signed-off-by: Lorenzo Stoakes &lt;lstoakes@gmail.com&gt;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> ## fs/userfaultfd.c ##</span>                                                             <span class="ansi38-245"> │ </span><span class="ansi38-231"> ## fs/userfaultfd.c ##</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">@@ fs/userfaultfd.c: static int userfaultfd_release(struct inode *inode, struct f</span><span class="ansi34">↴</span>  <span class="ansi38-245"> │ </span><span class="ansi38-231">@@ fs/userfaultfd.c: static int userfaultfd_release(struct inode *inode, struct f</span><span class="ansi34">↴</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                       <span class="ansi34">…</span><span class="ansi38-231">ile *file)</span>  <span class="ansi38-245"> │ </span>                                                                       <span class="ansi34">…</span><span class="ansi38-231">ile *file)</span>

<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> fs/userfaultfd.c: static int userfaultfd_release(struct inode *inode, struct fil </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-                 vma-&gt;vm_file, vma-&gt;vm_pgoff,</span>                                      <span class="ansi38-245"> │ </span><span class="ansi38-203">-                 vma-&gt;vm_file, vma-&gt;vm_pgoff,</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-                 vma_policy(vma),</span>                                                  <span class="ansi38-245"> │ </span><span class="ansi38-203">-                 vma_policy(vma),</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-                 NULL_VM_UFFD_CTX, anon_vma_name(vma));</span>                            <span class="ansi38-245"> │ </span><span class="ansi38-203">-                 NULL_VM_UFFD_CTX, anon_vma_name(vma));</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-22">-        if (prev) {</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-22">-            vma = prev;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-22">-        } else {</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-22">-            prev = vma;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-22">-        }</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        </span><span class="ansi38-149 ansi48-124">prev</span><span class="ansi38-149 ansi48-52"> = vma_modify_flags_uffd(&amp;vmi, prev, vma, vma-&gt;vm_start,</span><span class="ansi48-52">               </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        </span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22"> = vma_modify_flags_uffd(&amp;vmi, prev, vma, vma-&gt;vm_start,</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+                        </span><span class="ansi38-149 ansi48-124"> </span><span class="ansi38-149 ansi48-52">vma-&gt;vm_end, new_flags,</span><span class="ansi48-52">                                   </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+                        vma-&gt;vm_end, new_flags,</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+                        </span><span class="ansi38-149 ansi48-124"> </span><span class="ansi38-149 ansi48-52">NULL_VM_UFFD_CTX);</span><span class="ansi48-52">                                        </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+                        NULL_VM_UFFD_CTX);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="inv35 inv_foreground"> </span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">         vma_start_write(vma);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">         userfaultfd_set_vm_flags(vma, new_flags);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">         vma-&gt;vm_userfaultfd_ctx = NULL_VM_UFFD_CTX;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+</span>                                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-149">+</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52">         if (prev) {</span><span class="ansi48-52">                                                                </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52">             vma = prev;</span><span class="ansi48-52">                                                            </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52">         } else {</span><span class="ansi48-52">                                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        prev = vma;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">     }</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">     mmap_write_unlock(mm);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">     mmput(mm);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">@@ fs/userfaultfd.c: static int userfaultfd_register(struct userfaultfd_ctx *ctx,</span>   <span class="ansi38-245"> │ </span><span class="ansi38-231">@@ fs/userfaultfd.c: static int userfaultfd_register(struct userfaultfd_ctx *ctx,</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     unsigned long start, end, vma_end;</span>                                             <span class="ansi38-245"> │ </span><span class="ansi38-231">     unsigned long start, end, vma_end;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     struct vma_iterator vmi;</span>                                                       <span class="ansi38-245"> │ </span><span class="ansi38-231">     struct vma_iterator vmi;</span>

<span class="ansi38-245 ansi48-235">────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> fs/userfaultfd.c: static int userfaultfd_register(struct userfaultfd_ctx *ctx, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-            /* vma_merge() invalidated the mas */</span>                                  <span class="ansi38-245"> │ </span><span class="ansi38-203">-            /* vma_merge() invalidated the mas */</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-            vma = prev;</span>                                                            <span class="ansi38-245"> │ </span><span class="ansi38-203">-            vma = prev;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-            goto next;</span>                                                             <span class="ansi38-245"> │ </span><span class="ansi38-203">-            goto next;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        </span><span class="ansi38-149 ansi48-124">prev</span><span class="ansi38-149 ansi48-52"> = vma_modify_flags_uffd(&amp;vmi, prev, vma, start, vma_end,</span><span class="ansi48-52">              </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        </span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22"> = vma_modify_flags_uffd(&amp;vmi, prev, vma, start, vma_end,</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+                        </span><span class="ansi38-149 ansi48-124"> </span><span class="ansi38-149 ansi48-52">new_flags,</span><span class="ansi48-52">                                                </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+                        new_flags,</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+                        </span><span class="ansi38-149 ansi48-124"> </span><span class="ansi38-149 ansi48-52">(struct vm_userfaultfd_ctx){ctx});</span><span class="ansi48-52">                        </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+                        (struct vm_userfaultfd_ctx){ctx});</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        if (IS_ERR(</span><span class="ansi38-149 ansi48-124">prev</span><span class="ansi38-149 ansi48-52">)) {</span><span class="ansi48-52">                                                        </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        if (IS_ERR(</span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22">)) {</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+            ret = PTR_ERR(</span><span class="ansi38-149 ansi48-124">prev</span><span class="ansi38-149 ansi48-52">);</span><span class="ansi48-52">                                                   </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+            ret = PTR_ERR(</span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22">);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+            break;</span>                                                                 <span class="ansi38-245"> │ </span><span class="ansi38-149">+            break;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">         }</span>                                                                          <span class="ansi38-245"> │ </span><span class="ansi38-231">         }</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        if (vma-&gt;vm_start &lt; start) {</span>                                               <span class="ansi38-245"> │ </span><span class="ansi38-203">-        if (vma-&gt;vm_start &lt; start) {</span>

<span class="ansi38-245 ansi48-235">────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> fs/userfaultfd.c: static int userfaultfd_register(struct userfaultfd_ctx *ctx, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-                break;</span>                                                             <span class="ansi38-245"> │ </span><span class="ansi38-203">-                break;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        }</span>                                                                          <span class="ansi38-245"> │ </span><span class="ansi38-203">-        }</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    next:</span>                                                                          <span class="ansi38-245"> │ </span><span class="ansi38-203">-    next:</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+</span><span class="ansi48-52">                                                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        if (prev)</span><span class="ansi48-52">                                                                  </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+            vma = prev; /* vma_merge() invalidated the mas */</span><span class="ansi48-52">                      </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+</span>                                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-149">+</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">         /*</span>                                                                         <span class="ansi38-245"> │ </span><span class="ansi38-231">         /*</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">          * In the vma_merge() successful mprotect-like case 8:</span>                     <span class="ansi38-245"> │ </span><span class="ansi38-231">          * In the vma_merge() successful mprotect-like case 8:</span>

<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> fs/userfaultfd.c: static int userfaultfd_unregister(struct userfaultfd_ctx *ctx, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-                 vma_policy(vma),</span>                                                  <span class="ansi38-245"> │ </span><span class="ansi38-203">-                 vma_policy(vma),</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-                 NULL_VM_UFFD_CTX, anon_vma_name(vma));</span>                            <span class="ansi38-245"> │ </span><span class="ansi38-203">-                 NULL_VM_UFFD_CTX, anon_vma_name(vma));</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        if (prev) {</span>                                                                <span class="ansi38-245"> │ </span><span class="ansi38-203">-        if (prev) {</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-22">-            vma = prev;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-22">-            goto next;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        </span><span class="ansi38-149 ansi48-124">prev</span><span class="ansi38-149 ansi48-52"> = vma_modify_flags_uffd(&amp;vmi, prev, vma, start, vma_end,</span><span class="ansi48-52">              </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        </span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22"> = vma_modify_flags_uffd(&amp;vmi, prev, vma, start, vma_end,</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+                        </span><span class="ansi38-149 ansi48-124"> </span><span class="ansi38-149 ansi48-52">new_flags, NULL_VM_UFFD_CTX);</span><span class="ansi48-52">                             </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+                        new_flags, NULL_VM_UFFD_CTX);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        if (IS_ERR(</span><span class="ansi38-149 ansi48-124">prev</span><span class="ansi38-149 ansi48-52">)) {</span><span class="ansi48-52">                                                        </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        if (IS_ERR(</span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22">)) {</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+            ret = PTR_ERR(prev);</span>                                                   <span class="ansi38-245"> │ </span><span class="ansi38-149">+            ret = PTR_ERR(prev);</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+            break;</span>                                                                 <span class="ansi38-245"> │ </span><span class="ansi38-149">+            break;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-124">+</span><span class="ansi38-149 ansi48-52">        }</span><span class="ansi48-52">                                                                          </span><span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-28"> </span><span class="ansi38-231 ansi48-22">        }</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+</span><span class="ansi48-52">                                                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        if (prev)</span><span class="ansi48-52">                                                                  </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52">             vma = prev;</span><span class="ansi48-52">                                                            </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203 ansi48-52">-            goto next;</span><span class="ansi48-52">                                                             </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203 ansi48-52">-        }</span><span class="ansi48-52">                                                                          </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        if (vma-&gt;vm_start &lt; start) {</span>                                               <span class="ansi38-245"> │ </span><span class="ansi38-203">-        if (vma-&gt;vm_start &lt; start) {</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-            ret = split_vma(&amp;vmi, vma, start, 1);</span>                                  <span class="ansi38-245"> │ </span><span class="ansi38-203">-            ret = split_vma(&amp;vmi, vma, start, 1);</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-            if (ret)</span>                                                               <span class="ansi38-245"> │ </span><span class="ansi38-203">-            if (ret)</span>

<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> fs/userfaultfd.c: static int userfaultfd_unregister(struct userfaultfd_ctx *ctx, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-                break;</span>                                                             <span class="ansi38-245"> │ </span><span class="ansi38-203">-                break;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        }</span>                                                                          <span class="ansi38-245"> │ </span><span class="ansi38-203">-        }</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    next:</span>                                                                          <span class="ansi38-245"> │ </span><span class="ansi38-203">-    next:</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">         /*</span>                                                                         <span class="ansi38-245"> │ </span><span class="ansi38-231">         /*</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">          * In the vma_merge() successful mprotect-like case 8:</span>                     <span class="ansi38-245"> │ </span><span class="ansi38-231">          * In the vma_merge() successful mprotect-like case 8:</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">          * the next vma was merged into the current one and</span>                        <span class="ansi38-245"> │ </span><span class="ansi38-231">          * the next vma was merged into the current one and</span>

<span class="ansi38-245 ansi48-235">─────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/madvise.c: static int madvise_update_vma(struct vm_area_struct *vma, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">─────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     struct mm_struct *mm = vma-&gt;vm_mm;</span>                                             <span class="ansi38-245"> │ </span><span class="ansi38-231">     struct mm_struct *mm = vma-&gt;vm_mm;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     int error;</span>                                                                     <span class="ansi38-245"> │ </span><span class="ansi38-231">     int error;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    pgoff_t pgoff;</span>                                                                 <span class="ansi38-245"> │ </span><span class="ansi38-203">-    pgoff_t pgoff;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    struct vm_area_struct *merged;</span><span class="ansi48-52">                                                 </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     VMA_ITERATOR(vmi, mm, start);</span>                                                  <span class="ansi38-245"> │ </span><span class="ansi38-231">     VMA_ITERATOR(vmi, mm, start);</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> </span>                                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-231"> </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     if (new_flags == vma-&gt;vm_flags &amp;&amp; anon_vma_name_eq(anon_vma_name(vma), anon_</span><span class="ansi34">↴</span>  <span class="ansi38-245"> │ </span><span class="ansi38-231">     if (new_flags == vma-&gt;vm_flags &amp;&amp; anon_vma_name_eq(anon_vma_name(vma), anon_</span><span class="ansi34">↴</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                         <span class="ansi34">…</span><span class="ansi38-231">name)) {</span>  <span class="ansi38-245"> │ </span>                                                                         <span class="ansi34">…</span><span class="ansi38-231">name)) {</span>

<span class="ansi38-245 ansi48-235">─────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/madvise.c: static int madvise_update_vma(struct vm_area_struct *vma, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">─────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        vma = *prev;</span>                                                               <span class="ansi38-245"> │ </span><span class="ansi38-203">-        vma = *prev;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        goto success;</span>                                                              <span class="ansi38-245"> │ </span><span class="ansi38-203">-        goto success;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    }</span>                                                                              <span class="ansi38-245"> │ </span><span class="ansi38-203">-    }</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    </span><span class="ansi38-149 ansi48-124">merged</span><span class="ansi38-149 ansi48-52"> = vma_modify_flags_name(&amp;vmi, *prev, vma, start, end, new_flags,</span><span class="ansi48-52">        </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+    </span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22"> = vma_modify_flags_name(&amp;vmi, *prev, vma, start, end, new_flags,</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+                    </span><span class="ansi38-149 ansi48-124">   </span><span class="ansi38-149 ansi48-52">anon_name);</span><span class="ansi48-52">                                                 </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+                    anon_name);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    if (IS_ERR(</span><span class="ansi38-149 ansi48-124">merged</span><span class="ansi38-149 ansi48-52">))</span><span class="ansi48-52">                                                            </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+    if (IS_ERR(</span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22">))</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        return PTR_ERR(</span><span class="ansi38-149 ansi48-124">merged</span><span class="ansi38-149 ansi48-52">);</span><span class="ansi48-52">                                                    </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        return PTR_ERR(</span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22">);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> </span>                                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-231"> </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203 ansi48-124">-</span><span class="ansi38-203 ansi48-52">    *prev = vma;</span><span class="ansi48-52">                                                                   </span><span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-28"> </span><span class="ansi38-231 ansi48-22">    *prev = vma;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    if (merged)</span><span class="ansi48-52">                                                                    </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        vma = *prev = merged;</span><span class="ansi48-52">                                                      </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    else</span><span class="ansi48-52">                                                                           </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        *prev = vma;</span><span class="ansi48-52">                                                               </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> </span>                                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-231"> </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    if (start != vma-&gt;vm_start) {</span>                                                  <span class="ansi38-245"> │ </span><span class="ansi38-203">-    if (start != vma-&gt;vm_start) {</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        error = split_vma(&amp;vmi, vma, start, 1);</span>                                    <span class="ansi38-245"> │ </span><span class="ansi38-203">-        error = split_vma(&amp;vmi, vma, start, 1);</span>

<span class="ansi38-245 ansi48-235">─────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/madvise.c: static int madvise_update_vma(struct vm_area_struct *vma, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">─────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> ## mm/mempolicy.c ##</span>                                                               <span class="ansi38-245"> │ </span><span class="ansi38-231"> ## mm/mempolicy.c ##</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">@@ mm/mempolicy.c: static int mbind_range(struct vma_iterator *vmi, struct vm_are</span><span class="ansi34">↴</span>  <span class="ansi38-245"> │ </span><span class="ansi38-231">@@ mm/mempolicy.c: static int mbind_range(struct vma_iterator *vmi, struct vm_are</span><span class="ansi34">↴</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                   <span class="ansi34">…</span><span class="ansi38-231">a_struct *vma,</span>  <span class="ansi38-245"> │ </span>                                                                   <span class="ansi34">…</span><span class="ansi38-231">a_struct *vma,</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">         struct vm_area_struct **prev, unsigned long start,</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-22">         unsigned long end, struct mempolicy *new_pol)</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> {</span>                                                                                  <span class="ansi38-245"> │ </span><span class="ansi38-231"> {</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-124"> </span><span class="ansi38-231 ansi48-52">    struct vm_area_struct *merged;</span><span class="ansi48-52">                                                 </span><span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-28">-</span><span class="ansi38-203 ansi48-22">    struct vm_area_struct *merged;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     unsigned long vmstart, vmend;</span>                                                  <span class="ansi38-245"> │ </span><span class="ansi38-231">     unsigned long vmstart, vmend;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    pgoff_t pgoff;</span>                                                                 <span class="ansi38-245"> │ </span><span class="ansi38-203">-    pgoff_t pgoff;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    int err;</span>                                                                       <span class="ansi38-245"> │ </span><span class="ansi38-203">-    int err;</span>

<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/mempolicy.c: static int mbind_range(struct vma_iterator *vmi, struct vm_area_ </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    merged = vma_merge(vmi, vma-&gt;vm_mm, *prev, vmstart, vmend, vma-&gt;vm_flags,</span>      <span class="ansi38-245"> │ </span><span class="ansi38-203">-    merged = vma_merge(vmi, vma-&gt;vm_mm, *prev, vmstart, vmend, vma-&gt;vm_flags,</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-             vma-&gt;anon_vma, vma-&gt;vm_file, pgoff, new_pol,</span>                          <span class="ansi38-245"> │ </span><span class="ansi38-203">-             vma-&gt;anon_vma, vma-&gt;vm_file, pgoff, new_pol,</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-             vma-&gt;vm_userfaultfd_ctx, anon_vma_name(vma));</span>                         <span class="ansi38-245"> │ </span><span class="ansi38-203">-             vma-&gt;vm_userfaultfd_ctx, anon_vma_name(vma));</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    merged =  vma_modify_policy(vmi, *prev, vma, vmstart, vmend, new_pol);</span><span class="ansi48-52">         </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-124">+</span><span class="ansi38-149 ansi48-52">    if (</span><span class="ansi38-149 ansi48-124">IS_ERR(</span><span class="ansi38-149 ansi48-52">merged)</span><span class="ansi38-149 ansi48-124">)</span><span class="ansi48-52">                                                            </span><span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-28">-</span><span class="ansi38-203 ansi48-22">    if (merged)</span><span class="ansi38-203 ansi48-28"> {</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-22">-        *prev = merged;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-124">+</span><span class="ansi38-149 ansi48-52">        return </span><span class="ansi38-149 ansi48-124">PTR_ERR</span><span class="ansi38-149 ansi48-52">(merged);</span><span class="ansi48-52">                                                    </span><span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-28">-</span><span class="ansi38-203 ansi48-22">        return</span><span class="ansi38-203 ansi48-28"> vma_replace_policy</span><span class="ansi38-203 ansi48-22">(merged</span><span class="ansi38-203 ansi48-28">, new_pol</span><span class="ansi38-203 ansi48-22">);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+</span><span class="ansi48-52">                                                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52">     if (merged) {</span><span class="ansi48-52">                                                                  </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52">         *prev = merged;</span><span class="ansi48-52">                                                            </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52">         return vma_replace_policy(merged, new_pol);</span><span class="ansi48-52">                                </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-124"> </span><span class="ansi38-231 ansi48-52">    }</span><span class="ansi48-52">                                                                              </span><span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-28">-</span><span class="ansi38-203 ansi48-22">    }</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52"> </span><span class="ansi48-52">                                                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-22">-</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    if (vma-&gt;vm_start != vmstart) {</span>                                                <span class="ansi38-245"> │ </span><span class="ansi38-203">-    if (vma-&gt;vm_start != vmstart) {</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        err = split_vma(vmi, vma, vmstart, 1);</span>                                     <span class="ansi38-245"> │ </span><span class="ansi38-203">-        err = split_vma(vmi, vma, vmstart, 1);</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        if (err)</span>                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-203">-        if (err)</span>

<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/mempolicy.c: static int mbind_range(struct vma_iterator *vmi, struct vm_area_ </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        if (err)</span>                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-203">-        if (err)</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-            return err;</span>                                                            <span class="ansi38-245"> │ </span><span class="ansi38-203">-            return err;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    }</span>                                                                              <span class="ansi38-245"> │ </span><span class="ansi38-203">-    }</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203 ansi48-52">-</span><span class="ansi48-52">                                                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+    vma =  vma_modify_policy(vmi, *prev, vma, vmstart, vmend, new_pol);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+    if (IS_ERR(vma))</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        return PTR_ERR(vma);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="inv35 inv_foreground"> </span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     *prev = vma;</span>                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-231">     *prev = vma;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     return vma_replace_policy(vma, new_pol);</span>                                       <span class="ansi38-245"> │ </span><span class="ansi38-231">     return vma_replace_policy(vma, new_pol);</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52"> }</span><span class="ansi48-52">                                                                                  </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> ## mm/mlock.c ##</span>                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-231"> ## mm/mlock.c ##</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">@@ mm/mlock.c: static int mlock_fixup(struct vma_iterator *vmi, struct vm_area_st</span><span class="ansi34">↴</span>  <span class="ansi38-245"> │ </span><span class="ansi38-231">@@ mm/mlock.c: static int mlock_fixup(struct vma_iterator *vmi, struct vm_area_st</span><span class="ansi34">↴</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                       <span class="ansi34">…</span><span class="ansi38-231">ruct *vma,</span>  <span class="ansi38-245"> │ </span>                                                                       <span class="ansi34">…</span><span class="ansi38-231">ruct *vma,</span>

<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/mlock.c: static int mlock_fixup(struct vma_iterator *vmi, struct vm_area_stru </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     int nr_pages;</span>                                                                  <span class="ansi38-245"> │ </span><span class="ansi38-231">     int nr_pages;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     int ret = 0;</span>                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-231">     int ret = 0;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     vm_flags_t oldflags = vma-&gt;vm_flags;</span>                                           <span class="ansi38-245"> │ </span><span class="ansi38-231">     vm_flags_t oldflags = vma-&gt;vm_flags;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    struct vm_area_struct *merged;</span><span class="ansi48-52">                                                 </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52"> </span><span class="ansi48-52">                                                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52">     if (newflags == oldflags || (oldflags &amp; VM_SPECIAL) ||</span><span class="ansi48-52">                         </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52">         is_vm_hugetlb_page(vma) || vma == get_gate_vma(current-&gt;mm) ||</span><span class="ansi48-52">             </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">@@ mm/mlock.c: static int mlock_fixup(struct vma_iterator *vmi, struct vm_area_st</span><span class="ansi34">↴</span>  <span class="ansi38-245"> │ </span><span class="ansi38-231">@@ mm/mlock.c: static int mlock_fixup(struct vma_iterator *vmi, struct vm_area_st</span><span class="ansi34">↴</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                       <span class="ansi34">…</span><span class="ansi38-231">ruct *vma,</span>  <span class="ansi38-245"> │ </span>                                                                       <span class="ansi34">…</span><span class="ansi38-231">ruct *vma,</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">         /* don't set VM_LOCKED or VM_LOCKONFAULT and don't count */</span>                <span class="ansi38-245"> │ </span><span class="ansi38-231">         /* don't set VM_LOCKED or VM_LOCKONFAULT and don't count */</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">         goto out;</span>                                                                  <span class="ansi38-245"> │ </span><span class="ansi38-231">         goto out;</span>

<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/mlock.c: static int mlock_fixup(struct vma_iterator *vmi, struct vm_area_stru </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    if (*prev) {</span>                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-203">-    if (*prev) {</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        vma = *prev;</span>                                                               <span class="ansi38-245"> │ </span><span class="ansi38-203">-        vma = *prev;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        goto success;</span>                                                              <span class="ansi38-245"> │ </span><span class="ansi38-203">-        goto success;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    </span><span class="ansi38-149 ansi48-124">merged</span><span class="ansi38-149 ansi48-52"> = vma_modify_flags(vmi, *prev, vma, start, end, newflags);</span><span class="ansi48-52">              </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+    </span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22"> = vma_modify_flags(vmi, *prev, vma, start, end, newflags);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    if (IS_ERR(</span><span class="ansi38-149 ansi48-124">merged</span><span class="ansi38-149 ansi48-52">)) {</span><span class="ansi48-52">                                                          </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+    if (IS_ERR(</span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22">)) {</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        ret = PTR_ERR(</span><span class="ansi38-149 ansi48-124">merged</span><span class="ansi38-149 ansi48-52">);</span><span class="ansi48-52">                                                     </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        ret = PTR_ERR(</span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22">);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+        goto out;</span>                                                                  <span class="ansi38-245"> │ </span><span class="ansi38-149">+        goto out;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     }</span>                                                                              <span class="ansi38-245"> │ </span><span class="ansi38-231">     }</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> </span>                                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-231"> </span>

<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/mlock.c: static int mlock_fixup(struct vma_iterator *vmi, struct vm_area_stru </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">──────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        if (ret)</span>                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-203">-        if (ret)</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-            goto out;</span>                                                              <span class="ansi38-245"> │ </span><span class="ansi38-203">-            goto out;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    }</span>                                                                              <span class="ansi38-245"> │ </span><span class="ansi38-203">-    }</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    if (merged)</span><span class="ansi48-52">                                                                    </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        vma = *prev = merged;</span><span class="ansi48-52">                                                      </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-52"> </span><span class="ansi48-52">                                                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-22">-</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    if (end != vma-&gt;vm_end) {</span>                                                      <span class="ansi38-245"> │ </span><span class="ansi38-203">-    if (end != vma-&gt;vm_end) {</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        ret = split_vma(vmi, vma, end, 0);</span>                                         <span class="ansi38-245"> │ </span><span class="ansi38-203">-        ret = split_vma(vmi, vma, end, 0);</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        if (ret)</span>                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-203">-        if (ret)</span>

<span class="ansi38-245 ansi48-235">────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/mmap.c: int split_vma(struct vma_iterator *vmi, struct vm_area_struct *vma, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+ *</span>                                                                                 <span class="ansi38-245"> │ </span><span class="ansi38-149">+ *</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+ * If no merge is possible and the range does not span the entirety of the VMA,</span>    <span class="ansi38-245"> │ </span><span class="ansi38-149">+ * If no merge is possible and the range does not span the entirety of the VMA,</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+ * we then need to split the VMA to accommodate the change.</span>                        <span class="ansi38-245"> │ </span><span class="ansi38-149">+ * we then need to split the VMA to accommodate the change.</span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+ *</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+ * The function returns either the merged VMA, the original VMA if a split was</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+ * required instead, or an error if the split failed.</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+ */</span>                                                                                <span class="ansi38-245"> │ </span><span class="ansi38-149">+ */</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+struct vm_area_struct *vma_modify(struct vma_iterator *vmi,</span>                        <span class="ansi38-245"> │ </span><span class="ansi38-149">+struct vm_area_struct *vma_modify(struct vma_iterator *vmi,</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+                  struct vm_area_struct *prev,</span>                                     <span class="ansi38-245"> │ </span><span class="ansi38-149">+                  struct vm_area_struct *prev,</span>

<span class="ansi38-245 ansi48-235">────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/mmap.c: int split_vma(struct vma_iterator *vmi, struct vm_area_struct *vma, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+            return ERR_PTR(err);</span>                                                   <span class="ansi38-245"> │ </span><span class="ansi38-149">+            return ERR_PTR(err);</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+    }</span>                                                                              <span class="ansi38-245"> │ </span><span class="ansi38-149">+    }</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+</span>                                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-149">+</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    return </span><span class="ansi38-149 ansi48-124">NULL</span><span class="ansi38-149 ansi48-52">;</span><span class="ansi48-52">                                                                   </span><span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+    return </span><span class="ansi38-149 ansi48-28">vma</span><span class="ansi38-149 ansi48-22">;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+}</span>                                                                                  <span class="ansi38-245"> │ </span><span class="ansi38-149">+}</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149">+</span>                                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-149">+</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> /*</span>                                                                                 <span class="ansi38-245"> │ </span><span class="ansi38-231"> /*</span>

<span class="ansi38-245 ansi48-235">─────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/mprotect.c: mprotect_fixup(struct vma_iterator *vmi, struct mmu_gather *tlb, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">─────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     unsigned int mm_cp_flags = 0;</span>                                                  <span class="ansi38-245"> │ </span><span class="ansi38-231">     unsigned int mm_cp_flags = 0;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     unsigned long charged = 0;</span>                                                     <span class="ansi38-245"> │ </span><span class="ansi38-231">     unsigned long charged = 0;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    pgoff_t pgoff;</span>                                                                 <span class="ansi38-245"> │ </span><span class="ansi38-203">-    pgoff_t pgoff;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    struct vm_area_struct *merged;</span><span class="ansi48-52">                                                 </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     int error;</span>                                                                     <span class="ansi38-245"> │ </span><span class="ansi38-231">     int error;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> </span>                                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-231"> </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     if (newflags == oldflags) {</span>                                                    <span class="ansi38-245"> │ </span><span class="ansi38-231">     if (newflags == oldflags) {</span>

<span class="ansi38-245 ansi48-235">─────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┐</span>
<span class="ansi38-231"> mm/mprotect.c: mprotect_fixup(struct vma_iterator *vmi, struct mmu_gather *tlb, </span><span class="ansi38-245 ansi48-235">│</span>
<span class="ansi38-245 ansi48-235">─────────────────────────────────────────────────────────────────────────────────</span><span class="ansi38-245 ansi48-235">┘</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-               vma-&gt;vm_userfaultfd_ctx, anon_vma_name(vma));</span>                       <span class="ansi38-245"> │ </span><span class="ansi38-203">-               vma-&gt;vm_userfaultfd_ctx, anon_vma_name(vma));</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    if (*pprev) {</span>                                                                  <span class="ansi38-245"> │ </span><span class="ansi38-203">-    if (*pprev) {</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        vma = *pprev;</span>                                                              <span class="ansi38-245"> │ </span><span class="ansi38-203">-        vma = *pprev;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    merged = vma_modify_flags(vmi, *pprev, vma, start, end, newflags);</span><span class="ansi48-52">             </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    if (IS_ERR(merged)) {</span><span class="ansi48-52">                                                          </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        error = PTR_ERR(merged);</span><span class="ansi48-52">                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        goto fail;</span><span class="ansi48-52">                                                                 </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    }</span><span class="ansi48-52">                                                                              </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+</span><span class="ansi48-52">                                                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    if (merged) {</span><span class="ansi48-52">                                                                  </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        vma = *pprev = merged;</span><span class="ansi48-52">                                                     </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231 ansi48-124"> </span><span class="ansi38-231 ansi48-52">        VM_WARN_ON((vma-&gt;vm_flags ^ newflags) &amp; ~VM_SOFTDIRTY);</span><span class="ansi48-52">                    </span><span class="ansi38-245"> │ </span><span class="ansi38-203 ansi48-28">-</span><span class="ansi38-203 ansi48-22">        VM_WARN_ON((vma-&gt;vm_flags ^ newflags) &amp; ~VM_SOFTDIRTY);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        goto success;</span>                                                              <span class="ansi38-245"> │ </span><span class="ansi38-203">-        goto success;</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+    } else {</span><span class="ansi48-52">                                                                       </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-149 ansi48-52">+        *pprev = vma;</span><span class="ansi48-52">                                                              </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+    vma = vma_modify_flags(vmi, *pprev, vma, start, end, newflags);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+    if (IS_ERR(vma)) {</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        error = PTR_ERR(vma);</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="ansi38-149 ansi48-22">+        goto fail;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231">     }</span>                                                                              <span class="ansi38-245"> │ </span><span class="ansi38-231">     }</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-231"> </span>                                                                                   <span class="ansi38-245"> │ </span><span class="ansi38-231"> </span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203 ansi48-124">-</span><span class="ansi38-203 ansi48-52">    *pprev = vma;</span><span class="ansi48-52">                                                                  </span><span class="ansi38-245"> │ </span><span class="ansi38-231 ansi48-28"> </span><span class="ansi38-231 ansi48-22">    *pprev = vma;</span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203 ansi48-52">-</span><span class="ansi48-52">                                                                                   </span><span class="ansi38-245"> │ </span>
<span class="ansi1 ansi38-245 ansi48-233"></span>                                                                                    <span class="ansi38-245"> │ </span><span class="inv35 inv_foreground"> </span><span class="ansi48-22"></span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-    if (start != vma-&gt;vm_start) {</span>                                                  <span class="ansi38-245"> │ </span><span class="ansi38-203">-    if (start != vma-&gt;vm_start) {</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        error = split_vma(vmi, vma, start, 1);</span>                                     <span class="ansi38-245"> │ </span><span class="ansi38-203">-        error = split_vma(vmi, vma, start, 1);</span>
<span class="ansi1 ansi38-245 ansi48-233"></span><span class="ansi38-203">-        if (error)</span>                                                                 <span class="ansi38-245"> │ </span><span class="ansi38-203">-        if (error)</span>
</code></pre>
